<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER-DRAW 3D 雙模加權抽籤系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-red: #ff0055;
            --neon-purple: #bc13fe;
            --bg-dark: #020617;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-dark);
            font-family: 'Orbitron', 'Microsoft JhengHei', sans-serif;
            color: var(--neon-blue);
        }

        /* 初始啟動頁面 */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #0a192f 0%, #020617 100%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1s ease, visibility 1s;
        }

        .splash-content {
            text-align: center;
            border: 2px solid var(--neon-blue);
            padding: 50px;
            background: rgba(0, 242, 255, 0.05);
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.2);
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
        }

        .start-btn {
            background: var(--neon-blue);
            color: #000;
            border: none;
            padding: 20px 50px;
            font-size: 24px;
            font-weight: 900;
            cursor: pointer;
            letter-spacing: 5px;
            transition: 0.3s;
            margin-top: 30px;
            box-shadow: 0 0 20px var(--neon-blue);
        }

        .start-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 40px var(--neon-blue);
            background: #fff;
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .interface {
            position: relative;
            z-index: 10;
            pointer-events: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 40px;
            box-sizing: border-box;
        }

        .side-panel {
            pointer-events: auto;
            background: rgba(0, 20, 40, 0.7);
            backdrop-filter: blur(15px);
            border-left: 3px solid var(--neon-blue);
            padding: 25px;
            width: 320px;
            box-shadow: -10px 0 30px rgba(0, 242, 255, 0.2);
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            transform: translateX(280px);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .side-panel:hover {
            transform: translateX(0);
        }

        .panel-tab {
            position: absolute;
            left: -40px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--neon-blue);
            color: #000;
            padding: 20px 10px;
            writing-mode: vertical-lr;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px 0 0 5px;
            letter-spacing: 2px;
        }

        h2 {
            margin-top: 0;
            text-transform: uppercase;
            letter-spacing: 3px;
            border-bottom: 1px solid var(--neon-blue);
            padding-bottom: 10px;
            font-size: 1.1rem;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px;
            font-size: 11px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            cursor: pointer;
            transition: 0.3s;
        }

        .mode-btn.active {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 15px var(--neon-blue);
        }

        .mode-btn.active.penalty {
            background: var(--neon-red);
            border-color: var(--neon-red);
            box-shadow: 0 0 15px var(--neon-red);
        }

        textarea {
            width: 100%;
            height: 200px;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--neon-blue);
            color: #fff;
            padding: 10px;
            box-sizing: border-box;
            font-size: 14px;
            resize: none;
            margin-bottom: 15px;
            font-family: monospace;
        }

        .input-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .main-btn {
            background: transparent;
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 15px;
            width: 100%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.3s;
        }

        .main-btn:hover {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 30px var(--neon-blue);
        }

        .main-btn.penalty-mode:hover {
            background: var(--neon-red);
            border-color: var(--neon-red);
            box-shadow: 0 0 30px var(--neon-red);
        }

        .music-control {
            margin-top: 15px;
            border-top: 1px solid rgba(0, 242, 255, 0.3);
            padding-top: 10px;
            font-size: 12px;
        }

        #result-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
            pointer-events: none;
            width: 80%;
        }

        .winner-box {
            background: rgba(0, 242, 255, 0.15);
            border: 2px solid var(--neon-blue);
            padding: 20px 40px;
            margin: 15px auto;
            font-size: 48px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 20px var(--neon-blue);
            display: none;
            animation: slideIn 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }

        .winner-info {
            font-size: 16px;
            display: block;
            color: var(--neon-blue);
            opacity: 0.8;
            letter-spacing: 2px;
        }

        @keyframes slideIn {
            0% { opacity: 0; transform: scale(0.5) translateY(100px); filter: blur(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); }
        }

        .hud-scanline {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 5;
        }
    </style>
</head>
<body>

<!-- 初始遮罩 -->
<div id="splash-screen">
    <div class="splash-content">
        <h1 style="letter-spacing: 10px; margin: 0;">CYBER DRAW</h1>
        <p style="opacity: 0.6; margin-bottom: 20px;">CORE SYSTEM VERSION 4.5.2</p>
        <button class="start-btn" onclick="startSystem()">啟動系統終端</button>
    </div>
</div>

<div class="hud-scanline"></div>

<div class="interface">
    <div class="top-bar">
        <h1 id="system-title" style="margin:0; font-size: 24px; letter-spacing: 5px;">SYSTEM: LUCKY_DRAW_MODE</h1>
    </div>

    <div id="result-display"></div>

    <div class="side-panel">
        <div class="panel-tab">系統配置</div>
        <h2>抽籤邏輯設定</h2>
        <div class="mode-selector">
            <button class="mode-btn active" id="luckBtn" onclick="setMode('luck')">獎勵模式<br>(高分易中)</button>
            <button class="mode-btn" id="penaltyBtn" onclick="setMode('penalty')">處罰模式<br>(高分難中)</button>
        </div>

        <h2>候選名單數據</h2>
        <div class="input-group" style="display:block;">
            <textarea id="nameInput" onchange="updateSphere()">張小明,12
李小美,8
陳科技,15
林學霸,20
王普通,5
馬斯克,18
黃仁勳,25
蘇姿丰,22</textarea>
        </div>
        
        <div class="input-group">
            <label>抽取人數:</label>
            <input type="number" id="drawCount" value="1" min="1" style="background:#000; border:1px solid #00f2ff; color:#fff; padding:5px; width:60px;">
        </div>

        <button class="main-btn" id="execBtn" onclick="executeDraw()">開始掃描並抽取</button>

        <div class="music-control">
            <label>背景音樂控制:</label>
            <button id="bgmBtn" onclick="toggleBGM()" style="background:none; border:1px solid var(--neon-blue); color:var(--neon-blue); cursor:pointer; padding:2px 10px; font-size:10px; margin-left:10px;">ON</button>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.4" onchange="updateVolume(this.value)" style="width: 80px; vertical-align: middle; margin-left: 5px;">
        </div>
    </div>
</div>

<div id="canvas-container"></div>

<script>
    let scene, camera, renderer, globeGroup, particleSystem;
    let isDrawing = false;
    let currentRotationSpeed = 0.002;
    let nameSprites = [];
    let participants = [];
    let currentMode = 'luck';

    // --- 音效載入 ---
    const spinAudio = new Audio('https://cdn.pixabay.com/download/audio/2025/04/20/audio_7b2bfa0d2a.mp3?filename=mechanical-motor-starting-whirring-stopping-330043.mp3');
    const luckAudio = new Audio('https://cdn.pixabay.com/download/audio/2025/07/04/audio_5ed2f66d0d.mp3?filename=level-up-06-370051.mp3');
    const penaltyAudio = new Audio('https://cdn.pixabay.com/download/audio/2025/12/19/audio_203e5b172c.mp3?filename=glitch-noise-454247.mp3');
    
    // 背景音樂 (使用指定網址)
    const bgmAudio = new Audio('https://cdn.pixabay.com/download/audio/2025/09/29/audio_437e7d71e0.mp3?filename=cyberpunk-futuristic-city-cyberpunk-music-412355.mp3');
    bgmAudio.loop = true;
    bgmAudio.volume = 0.4;

    let bgmEnabled = false;

    // 系統啟動進入點
    function startSystem() {
        document.getElementById('splash-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('splash-screen').style.visibility = 'hidden';
        }, 1000);

        // 啟動 BGM
        bgmAudio.play().catch(e => console.log("Audio play blocked"));
        bgmEnabled = true;
        document.getElementById('bgmBtn').innerText = "ON";
        document.getElementById('bgmBtn').style.background = "var(--neon-blue)";
        document.getElementById('bgmBtn').style.color = "#000";

        init();
        animate();
    }

    function toggleBGM() {
        const btn = document.getElementById('bgmBtn');
        if (!bgmEnabled) {
            bgmAudio.play();
            btn.innerText = "ON";
            btn.style.background = "var(--neon-blue)";
            btn.style.color = "#000";
            bgmEnabled = true;
        } else {
            bgmAudio.pause();
            btn.innerText = "OFF";
            btn.style.background = "none";
            btn.style.color = "var(--neon-blue)";
            bgmEnabled = false;
        }
    }

    function updateVolume(val) {
        bgmAudio.volume = val;
    }

    function init() {
        if (scene) return; // 避免重複初始化
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 2000);
        camera.position.z = 550;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        globeGroup = new THREE.Group();
        scene.add(globeGroup);

        createParticles();
        updateSphere();

        window.addEventListener('resize', onWindowResize);
    }

    function createParticles() {
        const geometry = new THREE.BufferGeometry();
        const vertices = [];
        for (let i = 0; i < 1500; i++) {
            vertices.push(THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000));
        }
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
        const material = new THREE.PointsMaterial({ color: 0x00f2ff, size: 2, transparent: true, opacity: 0.4 });
        particleSystem = new THREE.Points(geometry, material);
        scene.add(particleSystem);
    }

    function setMode(mode) {
        currentMode = mode;
        const luckBtn = document.getElementById('luckBtn');
        const penaltyBtn = document.getElementById('penaltyBtn');
        const execBtn = document.getElementById('execBtn');
        const title = document.getElementById('system-title');

        luckBtn.classList.remove('active');
        penaltyBtn.classList.remove('active', 'penalty');

        if (mode === 'luck') {
            luckBtn.classList.add('active');
            execBtn.classList.remove('penalty-mode');
            title.innerText = "SYSTEM: LUCKY_DRAW_MODE";
            title.style.color = "var(--neon-blue)";
        } else {
            penaltyBtn.classList.add('active', 'penalty');
            execBtn.classList.add('penalty-mode');
            title.innerText = "SYSTEM: PENALTY_DRAW_MODE";
            title.style.color = "var(--neon-red)";
        }
        updateSphere();
    }

    function parseData() {
        return document.getElementById('nameInput').value.split('\n')
            .filter(line => line.trim() !== "")
            .map(line => {
                const parts = line.split(/[,,:，：\t]/);
                const name = parts[0].trim();
                const weight = parts[1] ? parseFloat(parts[1]) : 1;
                return { name, weight: isNaN(weight) ? 1 : weight };
            });
    }

    function updateSphere() {
        if (!globeGroup) return;
        while(globeGroup.children.length > 0) globeGroup.remove(globeGroup.children[0]);
        nameSprites = [];
        participants = parseData();
        const total = participants.length;
        const radius = 260;

        const maxW = Math.max(...participants.map(p => p.weight), 1);
        const minW = Math.min(...participants.map(p => p.weight), 1);

        participants.forEach((p, i) => {
            const y = 1 - (i / (total - 1)) * 2; 
            const radiusAtY = Math.sqrt(1 - y * y);
            const theta = 2.39996 * i; 

            let visualWeight;
            if (currentMode === 'luck') {
                visualWeight = 0.5 + (p.weight / maxW);
            } else {
                visualWeight = 0.5 + ((maxW + minW - p.weight) / maxW);
            }

            const sprite = createNameSprite(p.name, p.weight, visualWeight);
            sprite.position.set(Math.cos(theta) * radiusAtY * radius, y * radius, Math.sin(theta) * radiusAtY * radius);
            globeGroup.add(sprite);
            nameSprites.push(sprite);
        });
    }

    function createNameSprite(name, weight, scale) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 256; canvas.height = 80;

        const themeColor = currentMode === 'luck' ? '0, 242, 255' : '255, 0, 85';
        ctx.fillStyle = `rgba(${themeColor}, 0.1)`;
        ctx.fillRect(0, 0, 256, 80);
        ctx.strokeStyle = `rgba(${themeColor}, ${scale/2})`;
        ctx.lineWidth = 2;
        ctx.strokeRect(5, 5, 246, 70);
        
        ctx.font = 'bold 32px "Microsoft JhengHei"';
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.fillText(name, 128, 35);

        ctx.font = '16px "Orbitron"';
        ctx.fillStyle = `rgb(${themeColor})`;
        ctx.fillText(`LV.${weight}`, 128, 65);

        const texture = new THREE.CanvasTexture(canvas);
        const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture, transparent: true }));
        sprite.scale.set(70 * scale, 22 * scale, 1);
        return sprite;
    }

    function executeDraw() {
        if (isDrawing) return;
        const drawCount = parseInt(document.getElementById('drawCount').value);
        if (participants.length < drawCount) return alert("名單不足！");

        isDrawing = true;
        document.getElementById('result-display').innerHTML = '';

        // 播放旋轉音效，並調小背景音樂
        spinAudio.currentTime = 0;
        spinAudio.play().catch(e => {});
        const currentVol = bgmAudio.volume;
        if (bgmEnabled) bgmAudio.volume = 0.1;

        new TWEEN.Tween({ s: 0.002 })
            .to({ s: 0.4 }, 2000)
            .easing(TWEEN.Easing.Quadratic.In)
            .onUpdate((obj) => { currentRotationSpeed = obj.s; camera.position.z = 550 + Math.random() * 30; })
            .onComplete(() => { setTimeout(() => finalizeDraw(drawCount, currentVol), 1000); })
            .start();
    }

    function finalizeDraw(count, prevVol) {
        let pool = [...participants];
        const winners = [];
        const maxW = Math.max(...pool.map(p => p.weight), 1);
        const minW = Math.min(...pool.map(p => p.weight), 1);

        for (let i = 0; i < count; i++) {
            if (pool.length === 0) break;

            let totalWeight = 0;
            const adjustedPool = pool.map(p => {
                let w = (currentMode === 'luck') ? p.weight : (maxW + minW) - p.weight;
                totalWeight += w;
                return { ...p, calcW: w };
            });

            let r = Math.random() * totalWeight;
            for (let j = 0; j < adjustedPool.length; j++) {
                r -= adjustedPool[j].calcW;
                if (r <= 0) {
                    winners.push(adjustedPool[j]);
                    pool.splice(j, 1);
                    break;
                }
            }
        }

        new TWEEN.Tween({ s: 0.4 })
            .to({ s: 0.002 }, 3000)
            .easing(TWEEN.Easing.Exponential.Out)
            .onUpdate((obj) => { currentRotationSpeed = obj.s; camera.position.z = 550; })
            .onComplete(() => { 
                isDrawing = false; 
                displayWinners(winners); 
                // 恢復背景音樂音量
                if (bgmEnabled) bgmAudio.volume = prevVol;
            })
            .start();
    }

    function displayWinners(winners) {
        const resDiv = document.getElementById('result-display');
        const themeColor = (currentMode === 'luck') ? 'var(--neon-blue)' : 'var(--neon-red)';
        
        winners.forEach((w, i) => {
            setTimeout(() => {
                if (currentMode === 'luck') {
                    luckAudio.currentTime = 0;
                    luckAudio.play().catch(e => {});
                } else {
                    penaltyAudio.currentTime = 0;
                    penaltyAudio.play().catch(e => {});
                }

                const box = document.createElement('div');
                box.className = 'winner-box';
                box.style.borderColor = themeColor;
                box.style.boxShadow = `0 0 20px ${themeColor}`;
                box.style.display = 'block';
                box.innerHTML = `<span class="winner-info" style="color:${themeColor}">TARGET DETECTED [XP:${w.weight}]</span>${w.name}`;
                resDiv.appendChild(box);
            }, i * 600);
        });
    }

    function onWindowResize() {
        if (!camera) return;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate(time) {
        requestAnimationFrame(animate);
        TWEEN.update(time);
        if (globeGroup) {
            globeGroup.rotation.y += currentRotationSpeed;
            globeGroup.rotation.x += currentRotationSpeed * 0.3;
        }
        if (particleSystem) {
            particleSystem.rotation.y -= 0.0003;
        }
        if (renderer && scene && camera) {
            renderer.render(scene, camera);
        }
    }
</script>
</body>
</html>