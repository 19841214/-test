<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CYBER-DRAW 3D 缺交加權抽籤系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOI2MloQp3rLf2T90vxep9b4zwKsUWEIs",
            authDomain: "workshop-test-98617.firebaseapp.com",
            databaseURL: "https://workshop-test-98617-default-rtdb.firebaseio.com",
            projectId: "workshop-test-98617",
            storageBucket: "workshop-test-98617.firebasestorage.app",
            messagingSenderId: "636905955796",
            appId: "1:636905955796:web:cbd25e7a76bd7501d4b641",
            measurementId: "G-SXRLWPJZCL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sheets-lottery-v1';

        window.firebaseCtx = { auth, db, appId, setDoc, doc, getDoc, signInAnonymously };
    </script>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-red: #ff0055;
            --bg-dark: #020617;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: var(--bg-dark);
            font-family: 'Orbitron', 'Microsoft JhengHei', sans-serif;
            color: var(--neon-blue);
            touch-action: manipulation;
        }

        /* 初始啟動頁面 */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #0a192f 0%, #020617 100%);
            z-index: 2000; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 1s ease, visibility 1s;
        }

        .splash-content {
            text-align: center; border: 2px solid var(--neon-blue);
            padding: 30px; background: rgba(0, 242, 255, 0.05);
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.2);
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
            width: 80%; max-width: 400px;
        }

        .start-btn {
            background: var(--neon-blue); color: #000; border: none;
            padding: 15px 30px; font-size: 1.2rem; font-weight: 900;
            cursor: pointer; letter-spacing: 3px; transition: 0.3s;
            margin-top: 20px; box-shadow: 0 0 20px var(--neon-blue);
            width: 100%;
        }

        /* 介面層 */
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        .interface {
            position: relative; z-index: 10; pointer-events: none;
            height: 100vh; display: flex; flex-direction: column;
            justify-content: space-between; padding: 20px; box-sizing: border-box;
        }

        .side-panel {
            pointer-events: auto; background: rgba(0, 15, 30, 0.9);
            backdrop-filter: blur(20px); border-left: 2px solid var(--neon-blue);
            padding: 20px; width: 320px; box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
            position: absolute; right: 0; top: 0; bottom: 0;
            transform: translateX(calc(100% - 40px)); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .side-panel:hover, .side-panel.active { transform: translateX(0); }
        
        .side-panel.drawing-mode {
            transform: translateX(calc(100% - 40px)) !important;
            pointer-events: none;
        }

        .panel-tab {
            position: fixed;
            right: 0; top: 50%; transform: translateY(-50%) translateX(0);
            background: var(--neon-blue); color: #000; padding: 15px 10px;
            writing-mode: vertical-lr; cursor: pointer; font-weight: bold;
            border-radius: 8px 0 0 8px; letter-spacing: 2px; font-size: 14px;
            z-index: 100;
            transition: opacity 0.3s;
        }

        .side-panel:hover .panel-tab, .side-panel.active .panel-tab, .side-panel.drawing-mode .panel-tab { 
            opacity: 0; pointer-events: none; 
        }

        h1 { font-size: 1.2rem; letter-spacing: 2px; margin: 0; }
        h2 { text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid var(--neon-blue); padding-bottom: 5px; font-size: 0.85rem; margin-top: 15px; margin-bottom: 10px; }

        .sync-status { font-size: 10px; color: var(--neon-blue); margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .sync-dot { width: 8px; height: 8px; background: #0f0; border-radius: 50%; }

        textarea {
            width: 100%; height: 80px; background: rgba(0,0,0,0.5);
            border: 1px solid var(--neon-blue); color: #fff; padding: 8px;
            box-sizing: border-box; font-size: 12px; resize: none;
            margin-bottom: 10px; font-family: monospace;
        }

        .mode-selector { display: flex; gap: 5px; margin-bottom: 10px; }
        .mode-btn { flex: 1; padding: 8px 2px; font-size: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--neon-blue); color: var(--neon-blue); cursor: pointer; }
        .mode-btn.active { background: var(--neon-blue); color: #000; font-weight: bold; }
        .mode-btn.active.penalty { background: var(--neon-red); border-color: var(--neon-red); }

        .sheets-btn { background: #1d854d; color: #fff; border: none; padding: 10px; width: 100%; font-size: 12px; cursor: pointer; margin-bottom: 5px; font-weight: bold; border-radius: 4px; }

        .main-btn { background: transparent; border: 2px solid var(--neon-blue); color: var(--neon-blue); padding: 12px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: auto; margin-bottom: 20px; }
        .main-btn:active { background: var(--neon-blue); color: #000; }

        #result-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 100; pointer-events: none; width: 90%; }
        .winner-box { background: rgba(0, 242, 255, 0.2); border: 2px solid var(--neon-blue); padding: 15px 20px; margin: 10px auto; font-size: 26px; font-weight: 900; color: #fff; text-shadow: 0 0 15px var(--neon-blue); display: none; animation: slideIn 0.5s forwards; width: 100%; max-width: 500px; box-sizing: border-box; }
        .winner-info { font-size: 11px; display: block; color: var(--neon-blue); opacity: 0.9; letter-spacing: 1px; margin-bottom: 5px; }

        @keyframes slideIn { 0% { opacity: 0; transform: scale(0.8) translateY(50px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }

        @media (max-width: 768px) {
            .side-panel { width: 80%; padding-bottom: env(safe-area-inset-bottom); }
            .winner-box { font-size: 22px; padding: 10px 12px; }
            h1 { font-size: 0.9rem; }
            .interface { padding: 10px; }
            .panel-tab { padding: 12px 8px; font-size: 12px; }
        }

        .hud-scanline { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%); background-size: 100% 4px; pointer-events: none; z-index: 5; }
    </style>
</head>
<body>

<div id="splash-screen">
    <div class="splash-content">
        <h1 style="letter-spacing: 5px; margin-bottom: 10px;">CYBER DRAW</h1>
        <p id="splash-status" style="opacity: 0.6; font-size: 12px; margin-bottom: 20px;">讀取 Google Sheets 數據中...</p>
        <button id="start-node-btn" class="start-btn" onclick="startSystem()" disabled>啟動終端</button>
    </div>
</div>

<div class="hud-scanline"></div>

<div class="interface">
    <div class="top-bar" style="pointer-events: auto;">
        <h1 id="system-title">SYSTEM: LUCKY_MODE</h1>
    </div>

    <div id="result-display"></div>

    <div class="side-panel" id="sidePanel">
        <div class="panel-tab" id="panelTab" onclick="togglePanel()">數據與設定</div>
        
        <div class="sync-status">
            <div id="sync-dot" class="sync-dot"></div>
            <span id="sync-text">雲端同步就緒</span>
        </div>

        <h2>Google Sheets 串接</h2>
        <button class="sheets-btn" onclick="fetchGoogleSheets()">手動同步試算表</button>

        <h2>抽籤邏輯 (按缺交次數)</h2>
        <div class="mode-selector">
            <button class="mode-btn active" id="luckBtn" onclick="setMode('luck')">獎勵模式<br>(好易中)</button>
            <button class="mode-btn" id="penaltyBtn" onclick="setMode('penalty')">處罰模式<br>(壞易中)</button>
        </div>

        <h2>候選名單數據</h2>
        <textarea id="nameInput" oninput="handleInput()">載入中...</textarea>
        
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
            <label style="font-size: 12px;">抽取人數:</label>
            <input type="number" id="drawCount" value="1" min="1" style="background:#000; border:1px solid #00f2ff; color:#fff; padding:5px; width:60px;">
        </div>

        <button class="main-btn" id="execBtn" onclick="executeDraw()">執行抽取</button>

        <div style="margin-top: 10px; padding-bottom: 10px; font-size: 11px;">
            <label>BGM:</label>
            <button id="bgmBtn" onclick="toggleBGM()" style="background:none; border:1px solid var(--neon-blue); color:var(--neon-blue); cursor:pointer; padding:2px 10px; font-size:9px; margin-left:5px;">ON</button>
        </div>
    </div>
</div>

<div id="canvas-container"></div>

<script>
    let scene, camera, renderer, globeGroup, particleSystem;
    let isDrawing = false;
    let currentRotationSpeed = 0.002;
    let nameSprites = [];
    let participants = [];
    let currentMode = 'luck';
    let saveTimeout = null;

    const sheetsUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRMdCqcZC2GYnFKgZaNJmDy3f_9l73VK--nXvUzsNzfSXCXFt5tVLrD2OnEyBkfQxh9rCBFERETbxEy/pub?gid=0&single=true&output=csv";

    // 音效
    const spinAudio = new Audio('https://cdn.pixabay.com/download/audio/2025/04/20/audio_7b2bfa0d2a.mp3?filename=mechanical-motor-starting-whirring-stopping-330043.mp3');
    const luckAudio = new Audio('https://cdn.pixabay.com/download/audio/2025/07/04/audio_5ed2f66d0d.mp3?filename=level-up-06-370051.mp3');
    const penaltyAudio = new Audio('https://cdn.pixabay.com/download/audio/2025/12/19/audio_203e5b172c.mp3?filename=glitch-noise-454247.mp3');
    const bgmAudio = new Audio('https://cdn.pixabay.com/download/audio/2025/09/29/audio_437e7d71e0.mp3?filename=cyberpunk-futuristic-city-cyberpunk-music-412355.mp3');
    bgmAudio.loop = true;
    bgmAudio.volume = 0.4;
    let bgmEnabled = false;

    // 核心修正：偵測網頁可見度變化
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            // 當網頁被隱藏或跳開時，暫停所有音效
            bgmAudio.pause();
            spinAudio.pause();
            luckAudio.pause();
            penaltyAudio.pause();
        } else {
            // 當回到網頁時，如果 BGM 是開啟狀態，恢復播放
            if (bgmEnabled) {
                bgmAudio.play().catch(e => console.log("Auto-resume blocked"));
            }
        }
    });

    function togglePanel() {
        const panel = document.getElementById('sidePanel');
        panel.classList.toggle('active');
    }

    const checkFirebase = setInterval(() => {
        if (window.firebaseCtx) {
            clearInterval(checkFirebase);
            initAuth();
        }
    }, 500);

    async function initAuth() {
        const { auth, signInAnonymously } = window.firebaseCtx;
        try {
            await signInAnonymously(auth);
            await fetchGoogleSheets();
            document.getElementById('start-node-btn').disabled = false;
            document.getElementById('start-node-btn').innerText = "啟動終端";
        } catch (e) {
            document.getElementById('splash-status').innerText = "連線失敗。";
        }
    }

    async function fetchGoogleSheets() {
        document.getElementById('sync-dot').style.background = "#ff0";
        document.getElementById('sync-text').innerText = "Sheets 同步中...";
        try {
            const response = await fetch(sheetsUrl + "&t=" + Date.now());
            const data = await response.text();
            const lines = data.split('\n');
            let formattedText = "";
            lines.forEach((line, index) => {
                if (index === 0 && line.includes("姓名")) return;
                const cols = line.split(',');
                if (cols[0] && cols[0].trim() !== "") {
                    formattedText += `${cols[0].trim()},${cols[1] ? cols[1].trim() : "0"}\n`;
                }
            });
            document.getElementById('nameInput').value = formattedText.trim();
            document.getElementById('sync-dot').style.background = "#0f0";
            document.getElementById('sync-text').innerText = "數據同步成功";
            updateSphere();
            handleInput(false);
        } catch (e) {
            document.getElementById('sync-text').innerText = "同步失敗，讀取緩存";
            await loadData();
        }
    }

    async function loadData() {
        const { db, appId, doc, getDoc } = window.firebaseCtx;
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'lotteryConfig', 'config');
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) document.getElementById('nameInput').value = docSnap.data().names;
        updateSphere();
    }

    function handleInput(shouldUpdateSphere = true) {
        if (shouldUpdateSphere) updateSphere();
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(async () => {
            const { db, appId, doc, setDoc } = window.firebaseCtx;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'lotteryConfig', 'config');
                await setDoc(docRef, { names: document.getElementById('nameInput').value }, { merge: true });
            } catch (e) {}
        }, 1500);
    }

    function startSystem() {
        document.getElementById('splash-screen').style.opacity = '0';
        setTimeout(() => document.getElementById('splash-screen').style.visibility = 'hidden', 1000);
        bgmAudio.play().catch(() => {});
        bgmEnabled = true;
        initThree();
        animate();
    }

    function toggleBGM() {
        const btn = document.getElementById('bgmBtn');
        if (!bgmEnabled) { bgmAudio.play(); btn.innerText = "ON"; bgmEnabled = true; }
        else { bgmAudio.pause(); btn.innerText = "OFF"; bgmEnabled = false; }
    }

    function initThree() {
        if (scene) return;
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 2000);
        camera.position.z = window.innerWidth < 600 ? 700 : 550;
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        globeGroup = new THREE.Group();
        scene.add(globeGroup);
        createParticles();
        updateSphere();
        window.addEventListener('resize', onWindowResize);
    }

    function createParticles() {
        const geo = new THREE.BufferGeometry();
        const verts = [];
        for (let i = 0; i < 1500; i++) verts.push(THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000));
        geo.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));
        particleSystem = new THREE.Points(geo, new THREE.PointsMaterial({ color: 0x00f2ff, size: 2, transparent: true, opacity: 0.4 }));
        scene.add(particleSystem);
    }

    function updateSphere() {
        if (!globeGroup) return;
        while(globeGroup.children.length > 0) globeGroup.remove(globeGroup.children[0]);
        participants = document.getElementById('nameInput').value.split('\n').filter(l => l.trim() !== "").map(l => {
            const p = l.split(/[,,:，：\t]/);
            const w = p[1] ? parseFloat(p[1]) : 0;
            return { name: p[0].trim(), missCount: isNaN(w) ? 0 : w };
        });
        const total = participants.length;
        if (total === 0) return;
        const maxM = Math.max(...participants.map(p => p.missCount), 1);
        const radius = 260;

        participants.forEach((p, i) => {
            const y = 1 - (i / (total - 1)) * 2;
            const rAtY = Math.sqrt(1 - y * y);
            const theta = 2.39996 * i;
            let vw = (currentMode === 'penalty') ? 0.5 + (p.missCount / maxM) : 0.5 + ((maxM - p.missCount) / maxM);
            const sprite = createNameSprite(p.name, p.missCount, vw);
            sprite.position.set(Math.cos(theta) * rAtY * radius, y * radius, Math.sin(theta) * rAtY * radius);
            globeGroup.add(sprite);
        });
    }

    function createNameSprite(name, weight, scale) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 256; canvas.height = 80;
        const col = currentMode === 'luck' ? '0, 242, 255' : '255, 0, 85';
        ctx.fillStyle = `rgba(${col}, 0.15)`; ctx.fillRect(0,0,256,80);
        ctx.strokeStyle = `rgba(${col}, ${scale/2})`; ctx.lineWidth = 2; ctx.strokeRect(5,5,246,70);
        ctx.font = 'bold 32px "Microsoft JhengHei"'; ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.fillText(name, 128, 35);
        ctx.font = '14px "Orbitron"'; ctx.fillStyle = `rgb(${col})`; ctx.fillText(`MISSING: ${weight}`, 128, 65);
        const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas), transparent: true }));
        sprite.scale.set(70 * scale, 22 * scale, 1);
        return sprite;
    }

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('luckBtn').classList.toggle('active', mode === 'luck');
        document.getElementById('penaltyBtn').classList.toggle('active', mode === 'penalty');
        document.getElementById('penaltyBtn').classList.toggle('penalty', mode === 'penalty');
        document.getElementById('execBtn').classList.toggle('penalty-mode', mode === 'penalty');
        document.getElementById('system-title').innerText = mode === 'luck' ? "SYSTEM: LUCKY_MODE" : "SYSTEM: PENALTY_MODE";
        document.getElementById('system-title').style.color = mode === 'luck' ? "var(--neon-blue)" : "var(--neon-red)";
        updateSphere();
    }

    function executeDraw() {
        if (isDrawing) return;
        const count = parseInt(document.getElementById('drawCount').value);
        if (participants.length < count) return alert("名單不足！");
        isDrawing = true;
        document.getElementById('result-display').innerHTML = '';
        spinAudio.currentTime = 0; spinAudio.play().catch(()=>{});
        if (bgmEnabled) bgmAudio.volume = 0.1;
        
        const panel = document.getElementById('sidePanel');
        panel.classList.remove('active');
        panel.classList.add('drawing-mode');

        new TWEEN.Tween({ s: 0.002 }).to({ s: 0.4 }, 2000).easing(TWEEN.Easing.Quadratic.In).onUpdate(o => { currentRotationSpeed = o.s; camera.position.z = (window.innerWidth < 600 ? 700 : 550) + Math.random()*30; }).onComplete(() => {
            setTimeout(() => finalizeDraw(count), 1000);
        }).start();
    }

    function finalizeDraw(count) {
        let pool = [...participants];
        const winners = [];
        const maxM = Math.max(...pool.map(p => p.missCount), 1);
        for (let i = 0; i < count; i++) {
            let tw = 0;
            const adj = pool.map(p => {
                let w = (currentMode === 'luck') ? (maxM - p.missCount) + 1 : p.missCount + 1;
                tw += w; return { ...p, cw: w };
            });
            let r = Math.random() * tw;
            for (let j = 0; j < adj.length; j++) {
                r -= adj[j].cw;
                if (r <= 0) { winners.push(adj[j]); pool.splice(j, 1); break; }
            }
        }
        new TWEEN.Tween({ s: 0.4 }).to({ s: 0.002 }, 3000).easing(TWEEN.Easing.Exponential.Out).onUpdate(o => { currentRotationSpeed = o.s; camera.position.z = (window.innerWidth < 600 ? 700 : 550); }).onComplete(() => {
            isDrawing = false; displayWinners(winners);
            if (bgmEnabled) bgmAudio.volume = 0.4;
            document.getElementById('sidePanel').classList.remove('drawing-mode');
        }).start();
    }

    function displayWinners(winners) {
        const res = document.getElementById('result-display');
        const col = (currentMode === 'luck') ? 'var(--neon-blue)' : 'var(--neon-red)';
        winners.forEach((w, i) => {
            setTimeout(() => {
                const audio = currentMode === 'luck' ? luckAudio : penaltyAudio;
                audio.currentTime = 0; audio.play().catch(()=>{});
                const box = document.createElement('div');
                box.className = 'winner-box';
                box.style.borderColor = col; box.style.boxShadow = `0 0 20px ${col}`;
                box.style.display = 'block';
                box.innerHTML = `<span class="winner-info" style="color:${col}">IDENTIFIED [MISS: ${w.missCount}]</span>${w.name}`;
                res.appendChild(box);
            }, i * 600);
        });
    }

    function onWindowResize() {
        if (!camera) return;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        camera.position.z = window.innerWidth < 600 ? 700 : 550;
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate(time) {
        requestAnimationFrame(animate);
        TWEEN.update(time);
        if (globeGroup) { globeGroup.rotation.y += currentRotationSpeed; globeGroup.rotation.x += currentRotationSpeed * 0.3; }
        if (particleSystem) particleSystem.rotation.y -= 0.0003;
        if (renderer && scene && camera) renderer.render(scene, camera);
    }
</script>
</body>
</html>